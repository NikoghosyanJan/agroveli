import { api } from "./api";
import Cookies from "js-cookie";

const storeTokens = async (
  _,
  { queryFulfilled }
) => {
  try {
    const { data } = await queryFulfilled;
    Cookies.set('accessToken', data.access, { expires: 7 });
    Cookies.set('refreshToken', data.refresh, { expires: 7 });
  } catch (err) {
    console.error('Error storing tokens:', err);
  }
};

export const authApi = api.injectEndpoints({
  endpoints: (builder) => ({
    register: builder.mutation({
      query: (body) => ({
        url: "/api/v1/user/auth/register/",
        method: "POST",
        body,
      }),
    }),

    login: builder.mutation({
      query: (body) => ({
        url: "/api/v1/user/auth/login/",
        method: "POST",
        body,
      }),
      onQueryStarted: storeTokens,
    }),

    getProfile: builder.query({
      query: () => "/api/v1/user/auth/get/user/",
      providesTags: ["User"],
    }),
  }),
})

export const {
  useRegisterMutation,
  useLoginMutation,
  useGetProfileQuery,
} = authApi
